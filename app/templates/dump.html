<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Document</title>
</head>
<body>

    <main>
        <div class=" d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width: 280px; min-height: 100vh;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            </a>
        </br>
        <div class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-hourglass-split" viewBox="0 0 16 16">
                <path d="M2.5 15a.5.5 0 1 1 0-1h1v-1a4.5 4.5 0 0 1 2.557-4.06c.29-.139.443-.377.443-.59v-.7c0-.213-.154-.451-.443-.59A4.5 4.5 0 0 1 3.5 3V2h-1a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-1v1a4.5 4.5 0 0 1-2.557 4.06c-.29.139-.443.377-.443.59v.7c0 .213.154.451.443.59A4.5 4.5 0 0 1 12.5 13v1h1a.5.5 0 0 1 0 1zm2-13v1c0 .537.12 1.045.337 1.5h6.326c.216-.455.337-.963.337-1.5V2zm3 6.35c0 .701-.478 1.236-1.011 1.492A3.5 3.5 0 0 0 4.5 13s.866-1.299 3-1.48zm1 0v3.17c2.134.181 3 1.48 3 1.48a3.5 3.5 0 0 0-1.989-3.158C8.978 9.586 8.5 9.052 8.5 8.351z"/>
              </svg>
        </div>
        <div class="time">
       <h2>Timebox</h2> 
        </div>
        </br>
    
    </br>
            <ul class="nav nav-pills flex-column mb-auto">
              <hr>
              <li>
                <div class="top">
                <a href="http://localhost:8000" class="nav-link text-white ">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#speedometer2"></use></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-clipboard-check" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                  </svg>
                Top Tasks
                <hr>
                </a>
                </div>
              </li>
    
    
              <li>
                <div class="secondary">
                <a href="http://localhost:8000/secondary" class="nav-link text-white">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#table"></use></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-award-fill" viewBox="0 0 16 16">
                    <path d="m8 0 1.669.864 1.858.282.842 1.68 1.337 1.32L13.4 6l.306 1.854-1.337 1.32-.842 1.68-1.858.282L8 12l-1.669-.864-1.858-.282-.842-1.68-1.337-1.32L2.6 6l-.306-1.854 1.337-1.32.842-1.68L6.331.864z"/>
                    <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1z"/>
                  </svg>
                  Secondary Tasks
                
                  <hr>
                </a>
                </div>
              </li>
            
            </ul>
           
           
        </br>
            <ul>
                <div class="dump">
                <a href="http://localhost:8000/dump" class="nav-link text-white">
                    <svg class="bi me-2" width="16" height="16"><use xlink:href="#table"></use></svg>
                    <i class="fa-solid fa-dumpster-fire"></i>
                    Task Dump<hr>
                    
                </a>
            </ul>
            
            
        </div>

        <div class="flex" style="width: 100%; padding: 10px;">

        <div class="d-grid gap-2">
            <button class="btn btn-primary" type="button">TASK DUMP</button>


            <div class="backkground">
                <select style="width: 100%;" class="sel" id="taskSelect2">
                    <option  value=0 >Please select duration</option>
    
                </select>

                <select style="margin-top: 10px;width: 100%;" id="taskSelect">
                    <option value="">Select a task</option>
                </select>

                <button id="buttonassign" style="margin-top: 10px;width: 30%;" class="btn btn-primary">Assign</button>


                <table id="table" class="table  table-bordered table-striped" style="width: 100%; margin-top: 50px;font-size: 13px;">
                    <thead>
                      <tr>
                        <th scope="col">Task</th>
                        <th scope="col">StartTime</th>
                        <th scope="col">EndTime</th>
                        <th scope="col">Action</th>
                      </tr>
                    </thead>
                    <tbody id="displayTable">
                      
                    </tbody>
                  </table>

            </div>
  
        </div>

    </div>

    </main>



    <script>

        function assigned() {
            fetch("http://localhost:8000/tasks/assigned_tasks/", {
                method: "GET"
            })
                .then(function (res) {
                    return res.json()
                })
                .then(function (response) {
                    console.log(response);

                    const taskSelect = document.getElementById('taskSelect');
                response.forEach(p => {
                const option = document.createElement('option');
                option.value = p.task_id;
                option.textContent = p.task_name; 
                taskSelect.appendChild(option);
            });
                   
                })
                .catch(function (err) {
                    console.log(err);

                })
        }

        function loadTime(){
            fetch("http://localhost:8000/tasks/assigned_time_periods", {
                method: "GET"
            })
                .then(function (res) {
                    return res.json()
                })
                .then(function (response) {
                    console.log(response);

                    const taskSelect = document.getElementById('taskSelect2');
                response.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.start_time; 
                taskSelect.appendChild(option);
            });
                   
                })
                .catch(function (err) {
                    console.log(err);

                })
        }

        function Assign(){
            let time_ID=Number(document.getElementById("taskSelect2").value);
            let task_ID=Number(document.getElementById("taskSelect").value);

            console.log(task_ID,time_ID)

            fetch("http://localhost:8000/tasks/update_task_assignment/",{
                method:"PUT",
                headers:{
                    "content-type":"application/json"
                },
                body:JSON.stringify({task_id:task_ID,task_period_id:time_ID})
            })
            .then(function(res){
                return res.json()
            })
            .then(function(response){
                console.log(response)
                location.reload()
            })
            .catch(function(err){
                console.log(err)
            })
        }

        function displayTasks(arr) {
            document.getElementById("displayTable").innerHTML = "";

            arr.forEach(function (task, index) {
                let row = document.createElement("tr");

                let title = document.createElement("td");
                title.append(task.task_name);

                let start = document.createElement("td");
                start.append(task.start_time);

                let end=document.createElement("td");
                let time = task.start_time;
                let [hours, minutes, seconds] = time.split(":").map(Number);
                hours += 1;
                let newTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                end.append(newTime);

                let actions=document.createElement("td");

                let edit = document.createElement("i");
                edit.classList.add("fa-solid");
                edit.classList.add("fa-toggle-on");
                edit.classList.add("size")
                edit.onclick = unlinked.bind(this, task.task_assignment_id);
                actions.appendChild(edit);

                // let trash = document.createElement("i");
                // trash.classList.add("fa-solid");
                // trash.classList.add("fa-trash");
                // actions.appendChild(trash);

                row.appendChild(title);
                row.appendChild(start);
                row.appendChild(end);
                row.appendChild(actions)

                document.getElementById("displayTable").appendChild(row);
            })


        }

        function getAssigned(){

            fetch("http://localhost:8000/tasks/tasks_with_time/",{
                method:"GET",
            })
            .then(function(res){
                return res.json()
            })
            .then(function(response){
                console.log(response)
                displayTasks(response)
            })
            .catch(function(err){
                console.log(err)
            })
        }
        function unlinked(task_assignment_id){

            fetch("http://localhost:8000/tasks/unassign_task_and_time_period/" + task_assignment_id, {
                method:"DELETE",
            })
            .then(function(res){
                return res.json()
            })
            .then(function(response){
                console.log(response)
            })
            .catch(function(err){
                console.log(err)
            })
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTime()
            assigned()
            getAssigned()
        });

        document.getElementById("buttonassign").addEventListener("click",Assign)
    </script>
    
</body>
</html>